rules_version = '2';

// =============================================================================
// Firestore Security Rules for First Bank of Pig
// =============================================================================
//
// Data structure:
//   /families/{familyId}/
//     name: string
//     ownerUid: string
//     createdAt: timestamp
//     parents/{parentUid}/
//       email: string
//       joinedAt: timestamp
//     invites/{inviteId}/
//       code: string
//       expiresAt: timestamp
//       createdBy: string (parentUid)
//     children/{childId}/
//       name: string
//       createdAt: timestamp
//       devices/{deviceUid}/  (deviceUid = anonymous auth UID)
//         deviceName: string
//         registeredAt: timestamp
//         lastAccessedAt: timestamp
//       transactions/{txId}/
//         amount: number (cents, positive or negative)
//         description: string
//         date: timestamp (user-specified date)
//         createdAt: timestamp
//         modifiedAt: timestamp
//
// Access patterns:
//   - Parents (authenticated via Google): full read/write to their family
//   - Kids (authenticated anonymously): read-only to their specific child doc
//     ONLY if they have a registered device record
//   - Owner only: can manage invites and remove other parents
// =============================================================================

service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper functions
    // -------------------------------------------------------------------------

    // Check if the user is authenticated (any method)
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the user is a parent of this family
    function isParentOfFamily(familyId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/families/$(familyId)/parents/$(request.auth.uid));
    }

    // Check if the user is the owner of this family
    function isOwnerOfFamily(familyId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/families/$(familyId)).data.ownerUid == request.auth.uid;
    }

    // Check if the user has registered device access for this child
    function hasDeviceAccess(familyId, childId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/families/$(familyId)/children/$(childId)/devices/$(request.auth.uid));
    }

    // -------------------------------------------------------------------------
    // Family document rules
    // -------------------------------------------------------------------------

    match /families/{familyId} {
      // Parents can read their family
      allow read: if isParentOfFamily(familyId);

      // Any authenticated user can create a family (they become the owner)
      allow create: if isAuthenticated() &&
        request.resource.data.ownerUid == request.auth.uid;

      // Only parents can update family details (name, etc.)
      // Cannot change ownerUid
      allow update: if isParentOfFamily(familyId) &&
        request.resource.data.ownerUid == resource.data.ownerUid;

      // Only owner can delete the family
      allow delete: if isOwnerOfFamily(familyId);

      // ---------------------------------------------------------------------
      // Parents subcollection
      // ---------------------------------------------------------------------

      match /parents/{parentUid} {
        // Parents can see other parents in their family
        allow read: if isParentOfFamily(familyId);

        // Owner can add parents directly
        // Others must provide a valid, unexpired invite code for this family
        allow create: if isOwnerOfFamily(familyId) ||
          (isAuthenticated() && parentUid == request.auth.uid &&
           exists(/databases/$(database)/documents/inviteCodes/$(request.resource.data.inviteCode)) &&
           get(/databases/$(database)/documents/inviteCodes/$(request.resource.data.inviteCode)).data.familyId == familyId &&
           get(/databases/$(database)/documents/inviteCodes/$(request.resource.data.inviteCode)).data.expiresAt > request.time);

        // Only owner can remove parents (except owner can't remove themselves)
        allow delete: if isOwnerOfFamily(familyId) &&
          parentUid != request.auth.uid;

        // Parents can update their own record
        allow update: if isAuthenticated() && parentUid == request.auth.uid;
      }

      // ---------------------------------------------------------------------
      // Invites subcollection
      // ---------------------------------------------------------------------

      match /invites/{inviteId} {
        // Only owner can read invites
        allow read: if isOwnerOfFamily(familyId);

        // Only owner can create invites
        allow create: if isOwnerOfFamily(familyId);

        // Only owner can delete invites
        allow delete: if isOwnerOfFamily(familyId);

        // Invites should not be updated, only created/deleted
        allow update: if false;
      }

      // ---------------------------------------------------------------------
      // Children subcollection
      // ---------------------------------------------------------------------

      match /children/{childId} {
        // Parents can read all children
        // Kid devices with registered access can read their specific child
        allow read: if isParentOfFamily(familyId) || hasDeviceAccess(familyId, childId);

        // Only parents can create/update/delete children
        allow create, update, delete: if isParentOfFamily(familyId);

        // -----------------------------------------------------------------
        // Devices subcollection (registered kid devices)
        // -----------------------------------------------------------------

        match /devices/{deviceUid} {
          // Parents can read all devices
          // A device can read its own record (to check if it has access)
          allow read: if isParentOfFamily(familyId) ||
            (isAuthenticated() && deviceUid == request.auth.uid);

          // A device can register itself (deviceUid must match auth uid)
          // Must provide a valid lookup code for this family/child
          // Must use server timestamp for registeredAt and lastAccessedAt
          allow create: if isAuthenticated() &&
            deviceUid == request.auth.uid &&
            request.resource.data.registeredAt == request.time &&
            request.resource.data.lastAccessedAt == request.time &&
            exists(/databases/$(database)/documents/childLookup/$(request.resource.data.lookupCode)) &&
            get(/databases/$(database)/documents/childLookup/$(request.resource.data.lookupCode)).data.familyId == familyId &&
            get(/databases/$(database)/documents/childLookup/$(request.resource.data.lookupCode)).data.childId == childId;

          // Only the device itself can update its lastAccessedAt
          // Must use server timestamp and can only update lastAccessedAt
          allow update: if isAuthenticated() &&
            deviceUid == request.auth.uid &&
            request.resource.data.lastAccessedAt == request.time &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastAccessedAt']);

          // Parents can delete device access (to revoke)
          allow delete: if isParentOfFamily(familyId);
        }

        // -----------------------------------------------------------------
        // Transactions subcollection
        // -----------------------------------------------------------------

        match /transactions/{txId} {
          // Parents can read all transactions
          // Kid devices with registered access can read transactions
          allow read: if isParentOfFamily(familyId) || hasDeviceAccess(familyId, childId);

          // Only parents can create/update/delete transactions
          allow create, update, delete: if isParentOfFamily(familyId);
        }
      }
    }

    // -------------------------------------------------------------------------
    // Invite lookup collection (for finding invite by code)
    // -------------------------------------------------------------------------
    // This is a top-level collection that maps invite codes to family IDs
    // Structure: /inviteCodes/{code} -> { familyId, expiresAt }

    match /inviteCodes/{code} {
      // Anyone authenticated can look up a specific invite code by ID
      // But listing/querying all codes is restricted to prevent enumeration
      allow get: if isAuthenticated();
      allow list: if false;

      // Only family owners can create invite codes
      // The client must also create the invite in the family's invites subcollection
      allow create: if isAuthenticated() &&
        isOwnerOfFamily(request.resource.data.familyId);

      // Any parent of the family can delete (e.g. joining parent consumes the code)
      allow delete: if isAuthenticated() &&
        isParentOfFamily(resource.data.familyId);

      // No updates - delete and recreate
      allow update: if false;
    }

    // -------------------------------------------------------------------------
    // Child lookup collection (for kid devices to find their data)
    // -------------------------------------------------------------------------
    // Structure: /childLookup/{lookupCode} -> { familyId, childId }
    // The lookupCode is what gets encoded in the QR code for kid devices
    // Note: This is used for initial device setup only. After setup,
    // the device must register in the child's devices subcollection.

    match /childLookup/{lookupCode} {
      // Anyone authenticated can look up a specific code by ID
      // But listing/querying all codes is restricted to prevent enumeration
      allow get: if isAuthenticated();
      allow list: if false;

      // Only parents can create lookup codes for their children
      allow create: if isAuthenticated() &&
        isParentOfFamily(request.resource.data.familyId);

      // Only parents can delete
      allow delete: if isAuthenticated() &&
        isParentOfFamily(resource.data.familyId);

      // No updates
      allow update: if false;
    }
  }
}
